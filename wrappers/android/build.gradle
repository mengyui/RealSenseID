apply plugin: 'com.android.library'

android {
    compileSdk 31
    defaultConfig {
        minSdk 23
        targetSdk 27

        externalNativeBuild.cmake {
            cppFlags += ["-frtti", "-fexceptions", "-fvisibility=hidden", "-std=c++14"]
            arguments += ["-DRSID_PREVIEW=ON"]
        }

        ndk.abiFilters = ['arm64-v8a', 'x86_64']
    }

    externalNativeBuild {
        cmake {
            path = "../../CMakeLists.txt"
        }
    }

    flavorDimensions "default"
    productFlavors {
        unsecured {
            dimension "default"
            externalNativeBuild.cmake {
                arguments += ["-DRSID_SECURE=OFF", "-DRSID_TOOLS=OFF"]
            }
        }
        secured {
            dimension "default"
            externalNativeBuild.cmake {
                arguments += ["-DRSID_SECURE=ON", "-DRSID_TOOLS=ON"]
            }
        }
    }

    buildTypes {
        debug {
            debuggable true
            jniDebuggable true
            resValue "string", "app_version", "${defaultConfig.versionName}"
        }

        release {
            minifyEnabled false
            resValue "string", "app_version", "${defaultConfig.versionName}"
        }
    }

    libraryVariants.all { variant ->
        variant.outputs.all { output ->
            def libName = "RealSenseID"
            def buildType = variant.buildType.name
            def newName = "${libName}_${buildType}.aar"

            outputFileName = newName
        }
    }
}

project.afterEvaluate {
        // It allows CMake/SWIG to run before Android Studio complains about missing generated files
        javaPreCompileUnsecuredDebug.dependsOn externalNativeBuildUnsecuredDebug
        javaPreCompileUnsecuredRelease.dependsOn externalNativeBuildUnsecuredRelease
        javaPreCompileSecuredDebug.dependsOn externalNativeBuildSecuredDebug
        javaPreCompileSecuredRelease.dependsOn externalNativeBuildSecuredRelease
}
